age_donor >= 18 & age_donor < 65 ~ "18-64",
age_donor >= 65 ~ ">=65"
),
age_gap = age_recipient - age_donor,
more_than5_declined_offers = if_else(declined_offers > 5, TRUE, FALSE),
vpra_group = case_when(
vpra == 0 ~ "0%",
vpra > 0 & vpra < 85 ~ ">0%-<85%",
vpra >= 85 ~ ">=85%"
)
) %>%
mutate(recipient_age_group = factor(recipient_age_group, levels = c("<18", "18-64", ">=65")),
donor_age_group = factor(donor_age_group, levels = c("<18", "18-64", ">=65")),
vpra_group = factor(vpra_group, levels = c("0%", ">0%-<85%", ">=85%"))
)
stats_multi_run <- function(data, full_data, variable, ...) {
#' this function first calculates the percentage of each level within each model run,
#' and then the median (IQR) across model runs
dots <- list(...)
variable_name <- variable
by_vars <- dots$by #holds the current variable name and the 'by' variable name
# Recover by + variable columns via index
# this detour is necessary since the levels aren't accessible anymore
# in gtsummary version 2.1.0
recovered_data <- left_join(data, full_data[c("index", by_vars)], by = "index")
# Extract current level of the variable and by group
current_level <- unique(recovered_data[[variable_name]])
current_level_by <- unique(recovered_data[[by_vars[[1]]]])
# Return NULL row if either level is missing
if (length(current_level) == 0 | length(current_level_by) == 0) {
return(
tibble(
multi_model_perc_median = NULL,
multi_model_perc_q1 = NULL,
multi_model_perc_q3 = NULL,
multi_model_median = NULL,
multi_model_q1 = NULL,
multi_model_q3 = NULL
)
)
}
# Filter full_data for current 'by' level
grouped_by_data <- filter(full_data, .data[[by_vars[[1]]]] == current_level_by)
# Compute % stats
tbl_median_iqr <- grouped_by_data %>%
group_by(model_run_id) %>%
summarise(ratio = mean(.data[[variable_name]] == current_level, na.rm = TRUE) * 100,
.groups = "drop") %>%
summarise(
multi_model_perc_median = median(ratio),
multi_model_perc_q1 = quantile(ratio, 0.25),
multi_model_perc_q3 = quantile(ratio, 0.75),
.groups = "drop"
)
# Compute count stats
tbl_count <- data %>%
count(model_run_id, name = "count") %>%
summarise(
multi_model_median = median(count),
multi_model_q1 = quantile(count, 0.25),
multi_model_q3 = quantile(count, 0.75),
.groups = "drop"
)
bind_cols(tbl_count, tbl_median_iqr)
}
tmp_include <- c(
"recipient_age_group",
"donor_age_group",
"blood_group_recipient",
"blood_group_donor",
"vpra_group",
"hla_mm",
"region_recipient",
"region_donor",
"allocation_region_type"
)
categ_summary_tbl <- df_postmortem %>%
mutate(index = row_number()) %>% # index is necessary for an access of the current level
tbl_strata(
strata = model_name,
.tbl_fun = ~ tbl_custom_summary(
.x,
by = et_program,
include = tmp_include,
label = filter_labels_by_vars(clean_var_names, tmp_include),
stat_fns = all_categorical() ~ stats_multi_run,
statistic = all_categorical() ~ "{multi_model_perc_median}% [{multi_model_perc_q1}%–{multi_model_perc_q3}%]",
digits = list(
recipient_age_group ~ c(1, 1),
donor_age_group ~ c(1, 1),
blood_group_recipient ~ c(1, 1),
blood_group_donor ~ c(1, 1),
region_recipient ~ c(1, 1),
region_donor ~ c(1, 1),
allocation_region_type ~ c(1, 1),
vpra_group  ~ c(1, 1),
hla_mm ~ c(1,1)
)
)
)
tmp_include <- c("age_gap", "age_donor", "age_recipient")
cont_summary_tbl <- df_postmortem %>%
tbl_strata(strata = model_name,
.tbl_fun =
~ tbl_summary(
.x,
by = et_program,
include = tmp_include,
label = filter_labels_by_vars(clean_var_names, tmp_include),
))
tbl_stack(list(cont_summary_tbl, categ_summary_tbl)) %>%
modify_footnote(all_stat_cols() ~ "For continuous variables, the median [IQR] is calculated across all pooled simulations. For categorical variables, the percentage is first calculated within each model run, and then the median 6IQR] across model runs is reported.")
tmp_include <- c(
"recipient_age_group",
"donor_age_group",
"blood_group_recipient",
"blood_group_donor",
"vpra_group",
"hla_mm",
"region_recipient",
"region_donor",
"allocation_region_type"
)
categ_summary_tbl <- df_postmortem %>%
mutate(index = row_number()) %>%
tbl_custom_summary(
by = model_name,
include = tmp_include,
label = filter_labels_by_vars(clean_var_names, tmp_include),
stat_fns = all_categorical() ~ stats_multi_run,
statistic = all_categorical() ~ "{multi_model_perc_median}% [{multi_model_perc_q1}%–{multi_model_perc_q3}%]",
digits = list(
recipient_age_group ~ c(1, 1),
donor_age_group ~ c(1, 1),
blood_group_recipient ~ c(1, 1),
blood_group_donor ~ c(1, 1),
region_recipient ~ c(1, 1),
region_donor ~ c(1, 1),
allocation_region_type ~ c(1, 1),
vpra_group  ~ c(1, 1),
hla_mm ~ c(1,1)
)
)
tmp_include <- c("age_gap", "age_donor", "age_recipient")
cont_summary_tbl <- df_postmortem %>%
tbl_summary(
by = model_name,
include = tmp_include,
label = filter_labels_by_vars(clean_var_names, tmp_include),
)
tbl_stack(list(cont_summary_tbl, categ_summary_tbl)) %>%
modify_footnote(all_stat_cols() ~ "For continuous variables, the median [IQR] is calculated across all pooled simulations. For categorical variables, the percentage is first calculated within each model run, and then the median [IQR] across model runs is reported.")
# Calculate median and IQR of counts across model_run_ids for each age_recipient
dts_counts <- df_postmortem %>%
mutate(age_recipient_bin = floor(age_recipient)) %>%
group_by(model_name, model_run_id, age_recipient_bin) %>%
summarise(count = n(), .groups = "drop") %>%
group_by(model_name, age_recipient_bin) %>%
summarise(
median_count = median(count, na.rm = TRUE),
q1_count = quantile(count, 0.25, na.rm = TRUE),
q3_count = quantile(count, 0.75, na.rm = TRUE),
sd_count = sd(count, na.rm = TRUE),
.groups = "drop"
)
plot_rec_age_dist <- ggplot(data = dts_counts,
aes(x = age_recipient_bin + 0.5, y = median_count, fill = model_name)) +
geom_col(alpha = 0.6, width = 1) +
geom_errorbar(
data = dts_counts,
aes(x = age_recipient_bin + 0.5, ymin = q1_count, ymax = q3_count),
width = 0.5,
color = "grey20",
alpha = 0.8
) +
facet_wrap(~ model_name) +
ggtitle("Recipient Age Distribution") +
xlab("Recipient Age (binned)") +
ylab("Count") +
theme(legend.position = "none") +
scale_fill_manual(values = n2_palette)
plot_rec_age_dist
df_postmortem %>%
ggplot(aes(y = list_to_tx_time, x = model_name, color = model_name)) +
geom_boxplot(outliers = FALSE) +
facet_wrap(~ recipient_age_group) +
scale_color_manual(values = n2_palette, name = NULL) +
theme(legend.position = "none") +
xlab(NULL) +
ylab("List to Transplant Time (years)")
df_postmortem %>%
ggplot(aes(y = list_to_tx_time, x = model_name, color = model_name)) +
geom_boxplot(outliers = FALSE) +
facet_wrap(~ et_program) +
scale_color_manual(values = n2_palette, name = NULL) +
theme(legend.position = "none") +
xlab(NULL) +
ylab("List to Transplant Time (years)")
df_postmortem %>%
ggplot(aes(y = list_to_tx_time, x = model_name, color = model_name)) +
geom_boxplot(outliers = FALSE) +
scale_color_manual(values = n2_palette, NULL) +
theme(legend.position = "none") +
xlab(NULL) +
ylab("List to Transplant Time (years)")
plot_dial_to_tx_time_by_age <- df_postmortem %>%
ggplot(aes(y = dialysis_to_tx_time, x = model_name, color = model_name)) +
geom_boxplot(outliers = FALSE) +
facet_wrap(~ recipient_age_group) +
scale_color_manual(values = n2_palette, name = "Model") +
theme(legend.position = "none") +
xlab(NULL) +
ylab("Dialysis to Transplant Time (years)")
plot_dial_to_tx_time_by_program <- df_postmortem %>%
ggplot(aes(y = dialysis_to_tx_time, x = model_name, color = model_name)) +
geom_boxplot(outliers = FALSE) +
facet_wrap(~ et_program) +
scale_color_manual(values = n2_palette, name = "Model") +
theme(legend.position = "none") +
xlab(NULL) +
ylab("Dialysis to Transplant Time (years)")
plot_dial_to_tx_time <- df_postmortem %>%
ggplot(aes(y = list_to_tx_time, x = model_name, color = model_name)) +
geom_boxplot(outliers = FALSE) +
scale_color_manual(values = n2_palette, name = "Model") +
theme(legend.position = "none") +
xlab(NULL) +
ylab("Dialysis to Transplant Time (years)")
plot_dial_to_tx_time_by_age
plot_dial_to_tx_time_by_program
plot_dial_to_tx_time
label_list <- list(
age_recipient = "Recipient Age (years)",
list_to_tx_time = "List to Transplant Time (years)",
dialysis_to_tx_time = "Dialysis to Transplant Time (years)"
)
df_postmortem %>%
select(model_name, age_recipient, list_to_tx_time, dialysis_to_tx_time) %>%
mutate(age_group = case_when(
age_recipient < 18 ~ "< 18",
age_recipient >= 18 & age_recipient < 65 ~ "18 - 65",
age_recipient >= 65 ~ ">=65",
)) %>%
select(-age_recipient) %>%
tbl_strata(
strata = model_name,
.tbl_fun =
~ .x %>%
tbl_summary(by = age_group,
label = label_list,
) %>%
add_overall() %>%
modify_header(all_stat_cols() ~ "**{level}**"),
.combine_with = "tbl_stack"
) %>%
as_gt() %>%
tab_style(
style = gt::cell_text(weight = "bold"),
locations = gt::cells_row_groups(groups = everything())
) %>%
tab_spanner(label = "Age group (years)",
columns = c(stat_1, stat_2, stat_3))
plot_time_to_tx <- df_postmortem %>%
ggplot(aes(x = age_recipient, y = list_to_tx_time)) +
geom_point(
size = 0.01,
alpha = 0.01
) +
geom_vline(
xintercept = 65,
colour = "red",
size = 0.1
) +
facet_wrap(~ model_name) +
theme(legend.position = "none") +
xlab("Age (years)") +
ylab("Listing to Transplant Time (years)") +
ggtitle("Waitinglist time for transplanted patients",
subtitle = "All model runs are combined")
plot_time_to_tx
plot_ind_model_time_to_tx <- df_postmortem %>%
ggplot(aes(x = age_recipient, y = list_to_tx_time)) +
geom_point(
size = 0.01,
alpha = 0.01
) +
geom_vline(
xintercept = 65,
colour = "red",
size = 0.1
) +
facet_wrap(~ model_name + model_run_id) +
theme(legend.position = "none") +
xlab("Age (years)") +
ylab("Listing to Transplant Time (years)") +
ggtitle("Waitinglist Time for Transplanted Patients",
subtitle = "Each model run is shown individually")
plot_ind_model_time_to_tx
plot_dial_time_to_tx <- df_postmortem %>%
ggplot(aes(x = age_recipient, y = dialysis_to_tx_time)) +
geom_point(
size = 0.01,
alpha = 0.01
) +
geom_vline(
xintercept = 65,
colour = "red",
size = 0.1
) +
facet_wrap(~ model_name) +
theme(legend.position = "none") +
xlab("Age (years)")+
ylab("Dialysis to Transplant Time (years)") +
ggtitle("Dialysis Time for Transplanted Patients",
subtitle = "All model runs are combined")
plot_dial_time_to_tx
plot_ind_model_dial_time_to_tx <- df_postmortem %>%
ggplot(aes(x = age_recipient, y = dialysis_to_tx_time)) +
geom_point(
size = 0.01,
alpha = 0.01
) +
geom_vline(
xintercept = 65,
colour = "red",
size = 0.1
) +
facet_wrap(~ model_name + model_run_id) +
theme(legend.position = "none") +
xlab("Age (years)") +
ylab("Dialysis to Transplant Time (years)") +
ggtitle("Dialysis Time for transplanted patients",
subtitle = "Each model run is shown individually")
plot_ind_model_dial_time_to_tx
plot_age_gap <- df_postmortem %>%
ggplot(aes(x = age_recipient, y = age_donor)) +
geom_point(
size = 0.01,
alpha = 0.01
) +
geom_vline(
xintercept = 65,
colour = "red",
size = 0.1
) +
facet_wrap(~ model_name) +
theme(legend.position = "none") +
xlab("Age Recipient (years)")+
ylab("Age Donor (years)") +
ggtitle("Age Gap",
subtitle = "All model runs are combined")
plot_age_gap
plot_ind_model_age_gap <- df_postmortem %>%
ggplot(aes(x = age_recipient, y = age_donor)) +
geom_point(
alpha = 0.01,
size = 0.1
) +
geom_vline(
xintercept = 65,
colour = "red",
size = 0.1
) +
facet_wrap(~ model_name + model_run_id) +
theme(legend.position = "none") +
xlab("Age Recipient (years)")+
ylab("Age Donor (years)") +
ggtitle("Age gap",
subtitle = "each model run is shown individually")
plot_ind_model_age_gap
df_postmortem %>%
select(hla_mm, et_program, model_name, model_run_id) %>%
group_by(model_run_id, et_program, model_name) %>%
summarise(
"0" = sum(hla_mm == 0)/n() * 100,
"1" = sum(hla_mm == 1)/n() * 100,
"2" = sum(hla_mm == 2)/n() * 100,
"3" = sum(hla_mm == 3)/n() * 100,
"4" = sum(hla_mm == 4)/n() * 100,
"5" = sum(hla_mm == 5)/n() * 100,
"6" = sum(hla_mm == 6)/n() * 100,
.groups = "drop"
) %>%
ungroup() %>%
select(-c(model_run_id)) %>%
tbl_strata(
strata = model_name,
.tbl_fun =
~ .x %>%
tbl_summary(by = et_program,
type = list(c("0",
"1",
"2",
"3",
"4",
"5",
"6") ~ "continuous"),
statistic = all_continuous() ~ "{median}% ({p25}% - {p75}%)")
) %>%
modify_header(all_stat_cols() ~ "**{level}** (Models = {n})") %>%
modify_footnote(all_stat_cols() ~ "Median% (IQR%)") %>%
modify_header(label = "**HLA MM**")
plot_hlamm <- df_postmortem %>%
filter(!is.na(hla_mm)) %>%
group_by(model_name, model_run_id, hla_mm) %>%
summarise(count = n()) %>%
mutate(percent = count / sum(count) * 100) %>%
ungroup() %>%
group_by(model_name, hla_mm) %>%
summarise(
median_perc = median(percent),
q1_perc = quantile(percent, 0.25),
q3_perc = quantile(percent, 0.75),
) %>%
ungroup() %>%
ggplot(aes(x = factor(hla_mm), y = median_perc, fill = model_name)) +
geom_col(alpha = 0.6, width = 0.6, position = "dodge") +
geom_errorbar(aes(ymin = q1_perc, ymax = q3_perc),
width = 0.3, position = position_dodge(width = 0.6)) +
labs(y = "Percentage", x = "HLA Mismatches") +
scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 35)) +
theme(legend.position = "top") +
scale_fill_manual(values = n2_palette, name = "Model")
plot_hlamm_by_program <- df_postmortem %>%
filter(!is.na(hla_mm)) %>%
group_by(model_name, model_run_id, et_program, hla_mm) %>%
summarise(count = n()) %>%
mutate(percent = count / sum(count) * 100) %>%
ungroup() %>%
group_by(model_name, et_program, hla_mm) %>%
summarise(
median_perc = median(percent),
q1_perc = quantile(percent, 0.25),
q3_perc = quantile(percent, 0.75),
) %>%
ungroup() %>%
ggplot(aes(x = factor(hla_mm), y = median_perc, fill = model_name)) +
geom_col(alpha = 0.6, width = 0.6, position = "dodge") +
geom_errorbar(aes(ymin = q1_perc, ymax = q3_perc),
width = 0.3, position = position_dodge(width = 0.6)) +
labs(y = "Percentage", x = "HLA Mismatches") +
facet_wrap(~ et_program) +
scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 35)) +
theme(legend.position = "top") +
scale_fill_manual(values = n2_palette, name = "Model")
plot_hlamm
plot_hlamm_by_program
GetListedAtStep <- function(df, step) {
df %>%
filter(status_recipient != "living_donor_transplanted" &
if_else(step_added_to_model <= step,
if_else(step_transplanted >= step | step_removed_from_list >= step, TRUE, FALSE),
FALSE
)
) %>%
return()
}
steps <- (0:11)*36
results_dts <- lapply(steps, function(step) {
df_dts %>%
group_by(model_name) %>%
GetListedAtStep(step) %>%
mutate(
# time difference has to be calculated, since age, waiting time etc.
# increases until the step of removal, transplantation etc.
time_difference = (if_else(!is.na(step_transplanted),
step_transplanted - step,
if_else(!is.na(step_removed_from_list),
step_removed_from_list - step,
0)
)
) * step_size,
age = age_recipient - time_difference,
waitinglist_time = waitinglist_time - time_difference,
dialysis_time = dialysis_time - time_difference) %>%
summarise(
across(c(age, waitinglist_time, dialysis_time),
~ MedianIQR(.x, nsmall = 1, digits = 1),
.names = "{.col}_median_iqr")) %>%
mutate(date = as.Date("2006-01-01") + years(step * step_size), .before = age_median_iqr)
})
final_table_dts <- bind_rows(results_dts) %>%
pivot_wider(names_from = model_name,
values_from = c(age_median_iqr, waitinglist_time_median_iqr, dialysis_time_median_iqr))
final_table_dts %>%
select(date, contains("median_iqr")) %>%
gt() %>%
cols_label(
contains("date") ~ "Date",
contains("age") ~ "Age",
contains("waitinglist") ~ "Waiting List Time",
contains("dialysis") ~ "Dialysis Time",
) %>%
cols_align(align = "center", columns = everything()) %>%
tab_spanner(
label = "ESP Omitted",
columns = contains("ESP Omitted")
) %>%
tab_spanner(
label = "No Changes",
columns = contains("No Changes")
) %>%
tab_footnote(
footnote = "Median (IQR)",
locations = cells_column_labels(
columns = contains("median_iqr")
)
)
reticulate::repl_python()
here()
file.exists(here("data/model_input/CTS_spline_data_dwfg_10000_days.txt"))
reticulate::repl_python()
